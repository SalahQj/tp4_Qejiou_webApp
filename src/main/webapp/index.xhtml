<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <h:outputStylesheet name="css/mycsslayout.css"/>
    <h:outputScript name="js/script.js" target="head"/>
    <title>Conversation RAG (TP4 - LangChain4j avec PDF)</title>
    <style>
        .upload-section {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .rag-info {
            background-color: #e7f3ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .feature-badge {
            background-color: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
</h:head>
<h:body>
    <f:view>

        <h:messages errorStyle="color: red" showDetail="true" showSummary="false" globalOnly="true"/>

        <h:form id="roleForm">

            <p:outputLabel for="rolesysteme" value="R√¥le de l'API : "/>
            <p:selectOneMenu id="rolesysteme" value="#{bb.roleSysteme}" editable="true"
                             required="true" requiredMessage="Vous devez indiquer le r√¥le de l'API"
                             disabled="#{! bb.roleSystemeChangeable}">
                <f:selectItems value="#{bb.rolesSysteme}"/>
            </p:selectOneMenu>
            <h:message for="rolesysteme" errorStyle="color: red" />

            <h:outputText value="  "/>
            <h:commandButton value="Nouveau chat" action="#{bb.nouveauChat}" />
        </h:form>

        <hr/>

        <div class="upload-section">
            <h3>üìÅ Chargement de PDF pour le RAG <span class="feature-badge">Fonctionnalit√© 3</span></h3>

            <h:form id="pdfForm" enctype="multipart/form-data">
                <h:panelGrid columns="3" style="margin-bottom: 10px;">
                    <h:outputLabel for="file" value="Fichier PDF :"/>
                    <p:fileUpload id="file" value="#{bb.fichier}"
                                  mode="simple" skinSimple="true"
                                  allowTypes="/(\.|\/)(pdf)$/"
                                  requiredMessage="Veuillez s√©lectionner un fichier PDF"/>
                    <h:message for="file" errorStyle="color: red"/>
                </h:panelGrid>

                <p:commandButton value="üì§ Uploader le PDF"
                                 action="#{bb.upload}"
                                 update="@form:messageUpload @form:ragStatus chatForm:paneltotal"
                                 icon="pi pi-upload"
                                 ajax="false" style="margin-right: 10px;"/>

                <h:outputText id="messageUpload"
                              value="#{bb.messagePourChargementFichier}"
                              style="color: green; font-weight: bold;"/>
            </h:form>

            <div id="ragStatus" class="rag-info">
                <h:outputText value="üìä Statut RAG : " style="font-weight: bold;"/>
                <h:outputText value="Syst√®me de RAG actif avec embeddings locaux"
                              style="color: #007bff; font-weight: bold;"/>
                <br/>
                <h:outputText value="Fonctionnalit√©s activ√©es : "/>
                <ul>
                    <li>RAG avec documents PDF <span class="feature-badge">Fonctionnalit√© 2</span></li>
                    <li>Embedding local AllMiniLmL6V2 <span class="feature-badge">Fonctionnalit√© 4</span></li>
                    <li>Contr√¥le de diversit√© (topK=20) <span class="feature-badge">Fonctionnalit√© 1</span></li>
                    <li>Upload de fichiers PDF <span class="feature-badge">Fonctionnalit√© 3</span></li>
                </ul>
            </div>
        </div>

        <hr/>

        <h:form id="chatForm">
            <h:panelGrid id="paneltotal" columns="2" columnClasses="topAligned,topAligned">

                <h:panelGrid id="panelgauche" columns="1">
                    <h:panelGrid id="questionetreponse" columns="1">
                        <h:panelGroup>
                            <h:outputText value="Question :"/>
                            <button type="button" onclick="copyToClipboard('question')">Copier question</button>
                            <button type="button" onclick="toutEffacer()">Effacer question et r√©ponse</button>
                        </h:panelGroup>
                        <h:inputTextarea id="question" value="#{bb.question}" title="Question"
                                         cols="50" rows="5" placeholder="Posez votre question ici... Le syst√®me utilisera les PDF charg√©s pour r√©pondre."/>
                        <h:commandButton value="üöÄ Envoyer la question (avec RAG)" action="#{bb.envoyer}"
                                         update="panelgauche paneldroit"/> <h:panelGroup>
                        <h:outputText value="R√©ponse : "/>
                        <h:outputText value="(avec contexte RAG)" style="color: #666; font-size: 0.9em;"/>
                        <button type="button" onclick="copyToClipboard('reponse')">Copier r√©ponse</button>
                    </h:panelGroup>
                        <h:inputTextarea id="reponse" value="#{bb.reponse}" title="R√©ponse"
                                         cols="50" rows="15" readonly="true"
                                         style="background-color: #f8f9fa; border: 1px solid #28a745;"/>

                    </h:panelGrid>

                    <div class="rag-info">
                        <h4>üí° Comment utiliser le RAG :</h4>
                        <ol>
                            <li>Chargez un ou plusieurs fichiers PDF avec le formulaire ci-dessus</li>
                            <li>Posez des questions sp√©cifiques sur le contenu des documents</li>
                            <li>Le syst√®me recherchera les informations pertinentes dans les PDF</li>
                            <li>La r√©ponse sera g√©n√©r√©e en utilisant le contexte trouv√©</li>
                        </ol>
                        <p><strong>Exemple de questions :</strong></p>
                        <ul>
                            <li>"Quels sont les points principaux du document ?"</li>
                            <li>"Expliquez le chapitre 3 du PDF charg√©"</li>
                            <li>"Quelles sont les conclusions de l'√©tude ?"</li>
                        </ul>
                    </div>

                </h:panelGrid>

                <h:panelGrid id="paneldroit" columns="1" style="vertical-align: top;">
                    <h:panelGroup>
                        <h:outputText value="Historique de conversation :"/>
                        <button type="button" onclick="copyToClipboard('conversation')">Copier conversation</button>
                        <h:commandButton value="üßπ Effacer l'historique" action="#{bb.effacerHistorique}"
                                         style="margin-left: 10px; background-color: #dc3545; color: white;"
                                         update="paneldroit"/> </h:panelGroup>
                    <h:inputTextarea id="conversation" rows="30" cols="50" readonly="true"
                                     value="#{bb.conversation}" title="Conversation enti√®re"
                                     style="background-color: #f8f9fa;"/>

                    <div class="rag-info" style="margin-top: 15px;">
                        <h4>üìÑ Fichiers PDF charg√©s :</h4>
                        <h:dataTable value="#{bb.fichiersCharges}" var="fichier"
                                     rendered="#{not empty bb.fichiersCharges}"
                                     style="width: 100%;">
                            <h:column>
                                <f:facet name="header">Nom du fichier</f:facet>
                                #{fichier}
                            </h:column>
                        </h:dataTable>
                        <h:outputText value="Aucun fichier charg√©"
                                      rendered="#{empty bb.fichiersCharges}"
                                      style="color: #666; font-style: italic;"/>
                    </div>
                </h:panelGrid>

            </h:panelGrid>
        </h:form>
    </f:view>
</h:body>
</html>